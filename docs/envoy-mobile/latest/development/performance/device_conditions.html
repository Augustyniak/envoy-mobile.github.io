

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Analysis of device conditions &mdash; envoy-mobile 0.1.1-fa2ad8 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Development Tools" href="../tools/tools.html" />
    <link rel="prev" title="Analysis of CPU/battery impact" href="cpu_battery_impact.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> envoy-mobile
          

          
          </a>

          
            
            
              <div class="version">
                0.1.1-fa2ad8
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../start/start.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../development.html">Development</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="performance.html">Performance Analysis</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="binary_size.html">Analysis of Binary Size</a></li>
<li class="toctree-l3"><a class="reference internal" href="cpu_battery_impact.html">Analysis of CPU/battery impact</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Analysis of device conditions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#results">Results</a></li>
<li class="toctree-l4"><a class="reference internal" href="#experimentation-method">Experimentation method</a></li>
<li class="toctree-l4"><a class="reference internal" href="#analysis">Analysis</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tools/tools.html">Development Tools</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">envoy-mobile</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../development.html">Development</a> &raquo;</li>
        
          <li><a href="performance.html">Performance Analysis</a> &raquo;</li>
        
      <li>Analysis of device conditions</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/development/performance/device_conditions.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="analysis-of-device-conditions">
<span id="dev-performance-device-conditions"></span><h1>Analysis of device conditions<a class="headerlink" href="#analysis-of-device-conditions" title="Permalink to this headline">¶</a></h1>
<div class="section" id="results">
<h2>Results<a class="headerlink" href="#results" title="Permalink to this headline">¶</a></h2>
<div class="section" id="ios">
<h3>iOS<a class="headerlink" href="#ios" title="Permalink to this headline">¶</a></h3>
<p>Valid through SHA <a class="reference external" href="https://github.com/lyft/envoy-mobile/tree/f05d43f">f05d43f</a>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Envoy Mobile is currently unable to properly reconnect or switch between connections when the device
is switched between WiFi and cellular. This is a common issue with libraries that use BSD sockets,
and it is being fixed as part of <a class="reference external" href="https://github.com/lyft/envoy-mobile/issues/13">this issue</a>.</p>
</div>
<p>This test will need to be re-run after those changes. See below for more details.</p>
</div>
<div class="section" id="android">
<h3>Android<a class="headerlink" href="#android" title="Permalink to this headline">¶</a></h3>
<p>Valid through SHA <a class="reference external" href="https://github.com/lyft/envoy-mobile/tree/e85e553">e85e553</a>.</p>
<p>We did not observe any issues when switching between background/foreground or between WiFi/cellular.
Network requests resumed and were successful after a brief period of time.</p>
</div>
</div>
<div class="section" id="experimentation-method">
<h2>Experimentation method<a class="headerlink" href="#experimentation-method" title="Permalink to this headline">¶</a></h2>
<p>Modified versions of the “hello world” example apps were used to run the following experiments.
See the iOS/Android sections below for instructions on building the examples.</p>
<div class="section" id="id1">
<h3>iOS<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>The original investigation was completed as part of <a class="reference external" href="https://github.com/lyft/envoy-mobile/issues/128#issuecomment-516260951">this issue</a>.</p>
<p><strong>Configuration:</strong></p>
<ol class="arabic simple">
<li>Build the app using the following flags to allow us to build to a device with debugging symbols:</li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">bazel</span> <span class="pre">build</span> <span class="pre">ios_dist</span> <span class="pre">--config=ios</span> <span class="pre">--ios_multi_cpus=arm64</span> <span class="pre">--copt=-ggdb3</span></code></p>
<ol class="arabic simple" start="2">
<li>Add the outputted <code class="docutils literal notranslate"><span class="pre">Envoy.framework</span></code> to the example app</li>
<li>In the active scheme of the app’s Xcode <code class="docutils literal notranslate"><span class="pre">Environment</span> <span class="pre">Variables</span></code>, set <code class="docutils literal notranslate"><span class="pre">CFNETWORK_DIAGNOSTICS=3</span></code> to enable more verbose <code class="docutils literal notranslate"><span class="pre">CFNetwork</span></code> logs</li>
<li>Set Envoy’s logs to <code class="docutils literal notranslate"><span class="pre">trace</span></code></li>
</ol>
<p><strong>Experiment:</strong></p>
<p>Make single requests to a
<a class="reference external" href="https://github.com/Reflejo/TestNetworking/blob/master/TestNetworking/client.c">simple Python server</a>
that shows when the client connects, disconnects, and makes requests. These request should be routed
through Envoy <strong>using the socket implementation of Envoy Mobile via URLSession</strong>
(not calling directly into the Envoy Mobile library).</p>
<ul class="simple">
<li>Send a request on WiFi, then switch to cellular (disabling WiFi) and make more requests</li>
<li>Set <code class="docutils literal notranslate"><span class="pre">URLSessionConfiguration</span></code>’s <code class="docutils literal notranslate"><span class="pre">httpMaximumConnectionsPerHost</span></code> to <code class="docutils literal notranslate"><span class="pre">1</span></code> and try this again</li>
<li>Switch the phone to airplane mode and try making requests</li>
</ul>
<p><strong>Findings:</strong></p>
<p>Whenever we switched from WiFi to cellular (or vice versa), the next request would consistently fail
with <code class="docutils literal notranslate"><span class="pre">-1001</span> <span class="pre">kCFURLErrorTimedOut</span></code>. At the same time, we’d see the connection terminate on the server,
and we’d see logs from both Envoy and CFNetwork indicating that a new connection was established.</p>
<p>When we executed the next request, it would complete successfully.</p>
<p>If we did this more quickly and sent several requests in rapid succession,
<strong>the first would still fail and the subsequent requests would complete normally</strong>.</p>
<p>Setting the <code class="docutils literal notranslate"><span class="pre">URLSessionConfiguration</span></code>’s <code class="docutils literal notranslate"><span class="pre">httpMaximumConnectionsPerHost</span></code> to <code class="docutils literal notranslate"><span class="pre">1</span></code>
(preventing concurrent connections) and sending several requests in rapid succession resulted in all
of them failing after the <code class="docutils literal notranslate"><span class="pre">timeoutIntervalForRequest</span></code> specified on the <code class="docutils literal notranslate"><span class="pre">URLSessionConfiguration</span></code>.
This is the same behavior seen with libraries like gRPC which use BSD sockets.</p>
<p>Putting the phone in airplane mode resulted in all requests failing immediately
(instead of waiting for the specified timeout) because iOS was aware that it had no connectivity.</p>
</div>
<div class="section" id="id2">
<h3>Android<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Throughout all of the following steps, we tested to make validate if network requests succeeded
when making each of the lifecycle/network changes listed below.</p>
<p>Lifecycle experiment steps:</p>
<ol class="arabic simple">
<li>Open the example application</li>
<li>Background the application</li>
<li>Foreground the application</li>
</ol>
<p>Network experimentation steps:</p>
<ol class="arabic simple">
<li>Turn on WiFi</li>
<li>Open the example application</li>
<li>Turn off WiFi</li>
<li>Turn on WiFi</li>
<li>Turn on airplane mode</li>
<li>Turn off airplane mode</li>
</ol>
<p>Reproducing the Envoy example app:</p>
<ol class="arabic simple">
<li>Build the library using <code class="docutils literal notranslate"><span class="pre">bazel</span> <span class="pre">build</span> <span class="pre">android_dist</span> <span class="pre">--config=android</span></code></li>
<li>Run the app: <code class="docutils literal notranslate"><span class="pre">bazel</span> <span class="pre">mobile-install</span> <span class="pre">//examples/kotlin/hello_world:hello_envoy_kt</span> <span class="pre">--fat_apk_cpu=armeabi-v7a</span></code></li>
</ol>
</div>
</div>
<div class="section" id="analysis">
<h2>Analysis<a class="headerlink" href="#analysis" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id3">
<h3>iOS<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>Envoy is currently configured as such:</p>
<p><code class="docutils literal notranslate"><span class="pre">[URLSession]</span> <span class="pre">--&gt;</span> <span class="pre">[Socket]</span> <span class="pre">--&gt;</span> <span class="pre">[Envoy</span> <span class="pre">Mobile]</span> <span class="pre">--&gt;</span> <span class="pre">[Socket]</span> <span class="pre">--&gt;</span> <span class="pre">[Internet]</span></code></p>
<p>With the current configuration of sending traffic over URLSession and having Envoy proxy it through,
we identified issues with Envoy being able to reconnect or switch between connections when the device
underwent various network changes such as toggling between WiFi and cellular.</p>
<p>The experiment above indicates that when a working connection changes to inactive (i.e., by disabling WiFi and
forcing the phone to switch to cellular), the sockets aren’t notified of the change.
This is a commonly understood issue with BSD sockets on iOS, and is why Apple strongly advises against using them.</p>
<p>Switching networks then executing a request through URLSession resulted in the request timing out.
Executing another network request resulted in the following,
which could make it seem like Envoy was working properly at first glance (even though it wasn’t):</p>
<ul class="simple">
<li>iOS realized that the connection was dead and terminated its socket connection with Envoy, then re-established it</li>
<li>When the connection with Envoy was terminated, Envoy in turn terminated its socket connection with the outside Internet</li>
<li>When iOS reconnected to Envoy, Envoy also reconnected and selected the first available connection (cellular in this case)</li>
<li>Future requests succeeded because they were sent over the new/valid connection</li>
</ul>
<p>Essentially, URLSession forced Envoy to reconnect/switch to a valid connection when a request failed due to
the fact that it was disconnecting from Envoy and reconnecting to it.</p>
<p>This means:</p>
<ul class="simple">
<li>When Envoy is called as a library (instead of proxying URLSession over a socket), it will break because nothing will force it to reconnect to a valid connection</li>
<li>Restricting URLSession’s concurrent connections makes this problem immediately apparent even in today’s setup because the only existing connection becomes invalid</li>
</ul>
<p><a class="reference external" href="https://github.com/lyft/envoy-mobile/issues/13">Issue #13</a> will be implementing Apple-approved network solutions for the transport layer
on iOS (such as CFNetwork/Network.framework/etc.), which will resolve these problems.</p>
</div>
<div class="section" id="id4">
<h3>Android<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>The initial experiment was done purely by looking at the results shown on the UI in the example application. The requests
succeed after some time. To be certain that what we observed in the high level experiment were valid, we enabled <code class="docutils literal notranslate"><span class="pre">trace</span></code>
level logging within Envoy to ensure Envoy is getting the requests back.</p>
</div>
<div class="section" id="open-issues-regarding-device-conditions">
<h3>Open issues regarding device conditions<a class="headerlink" href="#open-issues-regarding-device-conditions" title="Permalink to this headline">¶</a></h3>
<p>For current issues with device conditions, please see issues with the
<a class="reference external" href="https://github.com/lyft/envoy-mobile/labels/perf%2Fdevice">perf/device label</a>.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../tools/tools.html" class="btn btn-neutral float-right" title="Development Tools" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="cpu_battery_impact.html" class="btn btn-neutral" title="Analysis of CPU/battery impact" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019 Lyft, Inc.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>